<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>æ ¼é²å‰äºš10å¤©ï½œå†™å®ç”µå½±é£åœ°çƒèˆªçº¿</title>
<style>
  :root{
    --bg:#05070c;
    --card:rgba(255,255,255,.075);
    --card2:rgba(255,255,255,.11);
    --text:rgba(255,255,255,.92);
    --muted:rgba(255,255,255,.62);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 900px at 20% 10%, #0c1b33 0%, var(--bg) 55%, #03050a 100%);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .stage{position:relative;width:min(100vw,540px);height:min(100vh,960px);margin:auto;top:50%;transform:translateY(-50%);border-radius:28px;overflow:hidden;border:1px solid rgba(255,255,255,.09);box-shadow:0 30px 120px rgba(0,0,0,.62);background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0))}
  canvas{position:absolute;inset:0;width:100%;height:100%;display:block}
  .glow{position:absolute;inset:-20%;
    background:
      radial-gradient(700px 500px at 70% 20%, rgba(90,180,255,.22), transparent 55%),
      radial-gradient(600px 500px at 20% 70%, rgba(255,180,120,.14), transparent 55%),
      radial-gradient(700px 700px at 60% 80%, rgba(120,255,170,.10), transparent 60%);
    filter:blur(12px);opacity:.92;pointer-events:none;
  }
  .topbar{position:absolute;left:16px;right:16px;top:14px;display:flex;justify-content:space-between;gap:12px;z-index:20;pointer-events:none}
  .brand{pointer-events:auto;padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(10px)}
  .brand .t1{font-size:12px;letter-spacing:1px;color:var(--muted)}
  .brand .t2{font-size:18px;font-weight:900;margin-top:2px}
  .pill{pointer-events:auto;padding:10px 12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(10px);display:flex;gap:8px;align-items:center;color:rgba(255,255,255,.78);font-size:12px}
  .dot{width:8px;height:8px;border-radius:50%;background:rgba(120,255,170,.95);box-shadow:0 0 18px rgba(120,255,170,.65)}
  .panel{position:absolute;left:14px;right:14px;bottom:14px;z-index:30;display:flex;flex-direction:column;gap:10px;pointer-events:none}
  .hero{pointer-events:auto;padding:14px 14px 12px;border-radius:18px;background:linear-gradient(180deg, rgba(255,255,255,.11), rgba(255,255,255,.055));border:1px solid rgba(255,255,255,.14);backdrop-filter:blur(12px);box-shadow:0 14px 55px rgba(0,0,0,.30)}
  .hero .row{display:flex;justify-content:space-between;align-items:baseline;gap:10px}
  .hero h1{margin:0;font-size:20px;letter-spacing:.2px}
  .badge{font-size:12px;color:rgba(255,255,255,.9);padding:6px 10px;border-radius:999px;white-space:nowrap;background:rgba(120,200,255,.14);border:1px solid rgba(120,200,255,.28)}
  .sub{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.3}
  .progress{margin-top:10px;height:3px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg, rgba(120,200,255,.95), rgba(255,210,120,.85));border-radius:999px;box-shadow:0 0 20px rgba(120,200,255,.28)}
  .grid{pointer-events:auto;display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .day{padding:12px 12px 10px;border-radius:16px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.11);backdrop-filter:blur(10px);transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease}
  .day:hover{transform:translateY(-1px)}
  .day.active{background:linear-gradient(180deg, rgba(255,255,255,.13), rgba(255,255,255,.06));border-color:rgba(120,200,255,.38);box-shadow:0 12px 40px rgba(60,140,255,.18)}
  .dnum{font-size:12px;color:rgba(255,255,255,.72);letter-spacing:.8px}
  .route{margin-top:6px;font-size:13px;line-height:1.25}
  .mini{margin-top:6px;font-size:11px;color:var(--muted);display:flex;gap:8px;align-items:center}
  .hint{position:absolute;left:16px;bottom: 230px;z-index:25;pointer-events:none;color:rgba(255,255,255,.55);font-size:11px;text-shadow:0 6px 24px rgba(0,0,0,.5)}
  @media (max-width:420px){.stage{width:100vw;height:100vh;border-radius:0;top:0;transform:none}.grid{grid-template-columns:1fr}.hint{bottom:250px}}

</style>
</head>
<body>
  <div class="stage">
    <div class="glow"></div>
    <canvas id="c"></canvas>

    <div class="topbar">
      <div class="brand">
        <div class="t1">GLOBE Â· ROUTE Â· MOTION</div>
        <div class="t2" id="brandTitle">æ ¼é²å‰äºš 10 å¤©æ¸¸ç¨‹</div>
      </div>
      <div class="pill"><span class="dot"></span><span id="status">æ’­æ”¾ä¸­ Â· èˆªçº¿åŠ¨æ•ˆ</span></div>
    </div>

    <div class="hint" id="hint">æç¤ºï¼šæ›´é«˜çº§çš„å…³é”®æ˜¯ã€Œè´´å›¾ + Bloom + ç”µå½±åæœŸã€</div>

    <div class="panel">
      <div class="hero">
        <div class="row">
          <h1 id="title">DAY 1ï½œåŒ—äº¬ â†’ ä¹Œé²æœ¨é½ â†’ ç¬¬æ¯”åˆ©æ–¯</h1>
          <div class="badge" id="mode">âœˆï¸ èˆªç©º</div>
        </div>
        <div class="sub" id="sub">è‡ªåŠ¨è½®æ’­ï¼ˆå¯ç‚¹ Dayï¼‰ï¼Œé€‚åˆå½•å±åšç´ æ</div>
        <div class="progress"><div class="bar" id="bar"></div></div>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

<script type="module">

import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
import { EffectComposer } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/EffectComposer.js";
import { RenderPass } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/RenderPass.js";
import { UnrealBloomPass } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/UnrealBloomPass.js";
import { ShaderPass } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/ShaderPass.js";
import { FilmPass } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/FilmPass.js";

const trips = [
  { day:1, mode:"plane", label:"å›½é™…æ®µ", routeText:"åŒ—äº¬ / ä¹Œé²æœ¨é½ / ç¬¬æ¯”åˆ©æ–¯",
    legs:[{name:"åŒ—äº¬",lat:39.9042,lon:116.4074},{name:"ä¹Œé²æœ¨é½",lat:43.8256,lon:87.6168},{name:"ç¬¬æ¯”åˆ©æ–¯",lat:41.7151,lon:44.8271}]},
  { day:2, mode:"car", label:"å¡èµ«å­£", routeText:"ç¬¬æ¯”åˆ©æ–¯ - æ³°æ‹‰ç»´ - è¥¿æ ¼çº³å‰",
    legs:[{name:"ç¬¬æ¯”åˆ©æ–¯",lat:41.7151,lon:44.8271},{name:"æ³°æ‹‰ç»´",lat:41.92,lon:45.47},{name:"è¥¿æ ¼çº³å‰",lat:41.62,lon:45.92}]},
  { day:3, mode:"car", label:"å›åŸ", routeText:"è¥¿æ ¼çº³å‰ - ç¬¬æ¯”åˆ©æ–¯",
    legs:[{name:"è¥¿æ ¼çº³å‰",lat:41.62,lon:45.92},{name:"ç¬¬æ¯”åˆ©æ–¯",lat:41.7151,lon:44.8271}]},
  { day:4, mode:"car", label:"å†›é“ä¸Šå±±", routeText:"ç¬¬æ¯”åˆ©æ–¯ - å§†èŒ¨èµ«å¡” - å¤å¤šé‡Œ",
    legs:[{name:"ç¬¬æ¯”åˆ©æ–¯",lat:41.7151,lon:44.8271},{name:"å§†èŒ¨èµ«å¡”",lat:41.845,lon:44.718},{name:"å¤å¤šé‡Œ",lat:42.477,lon:44.477}]},
  { day:5, mode:"car", label:"é›ªå±±å¾€è¿”", routeText:"å¤å¤šé‡Œ - å¡å…¹åˆ«å‰ - å¤å¤šé‡Œ",
    legs:[{name:"å¤å¤šé‡Œ",lat:42.477,lon:44.477},{name:"å¡å…¹åˆ«å‰",lat:42.658,lon:44.643},{name:"å¤å¤šé‡Œ",lat:42.477,lon:44.477}]},
  { day:6, mode:"car", label:"è½¬çº¿æ³¡æ±¤", routeText:"å¤å¤šé‡Œ - å“¥é‡Œ - åšå°”è‹¥ç±³",
    legs:[{name:"å¤å¤šé‡Œ",lat:42.477,lon:44.477},{name:"å“¥é‡Œ",lat:41.985,lon:44.109},{name:"åšå°”è‹¥ç±³",lat:41.839,lon:43.384}]},
  { day:7, mode:"car", label:"å¤å ¡å²©åŸ", routeText:"åšå°”è‹¥ç±³ - é˜¿å“ˆå°”é½èµ« - ç“¦å°”é½äºš - åšå°”è‹¥ç±³",
    legs:[{name:"åšå°”è‹¥ç±³",lat:41.839,lon:43.384},{name:"é˜¿å“ˆå°”é½èµ«",lat:41.64,lon:42.99},{name:"ç“¦å°”é½äºš",lat:41.38,lon:43.28},{name:"åšå°”è‹¥ç±³",lat:41.839,lon:43.384}]},
  { day:8, mode:"car", label:"è¥¿è¡Œ", routeText:"åšå°”è‹¥ç±³ - åº“å¡”ä¼Šè¥¿",
    legs:[{name:"åšå°”è‹¥ç±³",lat:41.839,lon:43.384},{name:"åº“å¡”ä¼Šè¥¿",lat:42.266,lon:42.718}]},
  { day:9, mode:"car", label:"å›é¦–éƒ½", routeText:"åº“å¡”ä¼Šè¥¿ - ç¬¬æ¯”åˆ©æ–¯",
    legs:[{name:"åº“å¡”ä¼Šè¥¿",lat:42.266,lon:42.718},{name:"ç¬¬æ¯”åˆ©æ–¯",lat:41.7151,lon:44.8271}]},
  { day:10, mode:"plane", label:"è¿”ç¨‹", routeText:"ç¬¬æ¯”åˆ©æ–¯ / ä¹Œé²æœ¨é½ / åŒ—äº¬",
    legs:[{name:"ç¬¬æ¯”åˆ©æ–¯",lat:41.7151,lon:44.8271},{name:"ä¹Œé²æœ¨é½",lat:43.8256,lon:87.6168},{name:"åŒ—äº¬",lat:39.9042,lon:116.4074}]},
];
const MODE = { plane:"âœˆï¸ èˆªç©º", car:"ğŸš— ç”¨è½¦" };


const grid = document.getElementById("grid");
const titleEl = document.getElementById("title");
const modeEl = document.getElementById("mode");
const statusEl = document.getElementById("status");
const barEl = document.getElementById("bar");
document.getElementById("hint").textContent = "å†™å®ç”µå½±é£ï¼šçœŸå®åœ°çƒè´´å›¾ + äº‘å±‚ + Bloom + ç”µå½±é¢—ç²’";

function iconSVG(mode){
  if(mode==="plane") return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="filter:drop-shadow(0 0 10px rgba(120,200,255,.25))">
    <path d="M21 16l-8-3V4.5a1.5 1.5 0 10-3 0V13L3 16v2l7-1v3l-2 1v1l3-.5 3 .5v-1l-2-1v-3l7 1v-2z"
      stroke="rgba(120,200,255,.95)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>`;
  return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="filter:drop-shadow(0 0 10px rgba(255,210,120,.22))">
    <path d="M5 16l1-4a3 3 0 013-2h6a3 3 0 013 2l1 4" stroke="rgba(255,210,120,.95)" stroke-width="1.6" stroke-linecap="round"/>
    <path d="M7 16a2 2 0 104 0M13 16a2 2 0 104 0" stroke="rgba(255,210,120,.95)" stroke-width="1.6" stroke-linecap="round"/>
    <path d="M7 10l1-2h8l1 2" stroke="rgba(255,210,120,.75)" stroke-width="1.4" stroke-linecap="round"/>
  </svg>`;
}

function renderCards(){
  grid.innerHTML = trips.map(t=>`
    <div class="day" data-day="${t.day}">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <div class="dnum">DAY ${t.day}</div>
        <div class="dnum" style="opacity:.85">${t.label}</div>
      </div>
      <div class="route">${t.routeText}</div>
      <div class="mini">${iconSVG(t.mode)} <span>${MODE[t.mode]}</span></div>
    </div>
  `).join("");
}

renderCards();

grid.addEventListener("click",(e)=>{
  const card = e.target.closest(".day"); if(!card) return;
  idx = Number(card.dataset.day)-1;
  slideStart = performance.now();
  setTrip(idx);
});

const canvas = document.getElementById("c");
const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.05;

const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 600);
camera.position.set(0, 0, 34);

scene.add(new THREE.AmbientLight(0xffffff, 0.35));
const key = new THREE.DirectionalLight(0xbfe6ff, 1.35); key.position.set(10, 8, 12); scene.add(key);
const warm = new THREE.DirectionalLight(0xffd6a8, 0.55); warm.position.set(-10, -6, -10); scene.add(warm);

// stars
const starsGeo=new THREE.BufferGeometry();
const n=1800;
const pos=new Float32Array(n*3);
for(let i=0;i<n;i++){
  const r=120+Math.random()*160;
  const th=Math.random()*Math.PI*2;
  const ph=Math.acos(2*Math.random()-1);
  pos[i*3]=r*Math.sin(ph)*Math.cos(th);
  pos[i*3+1]=r*Math.sin(ph)*Math.sin(th);
  pos[i*3+2]=r*Math.cos(ph);
}
starsGeo.setAttribute("position", new THREE.BufferAttribute(pos,3));
scene.add(new THREE.Points(starsGeo, new THREE.PointsMaterial({color:0xffffff,size:0.08,transparent:true,opacity:0.55})));

const globeGroup = new THREE.Group();
scene.add(globeGroup);
const radius = 7.6;

function latLonToVec3(lat, lon, r=radius){
  const phi=(90-lat)*Math.PI/180;
  const theta=(lon+180)*Math.PI/180;
  const x=-r*Math.sin(phi)*Math.cos(theta);
  const z= r*Math.sin(phi)*Math.sin(theta);
  const y= r*Math.cos(phi);
  return new THREE.Vector3(x,y,z);
}

const loader = new THREE.TextureLoader();
const texEarth = loader.load("https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg");
const texNormal = loader.load("https://threejs.org/examples/textures/planets/earth_normal_2048.jpg");
const texSpec   = loader.load("https://threejs.org/examples/textures/planets/earth_specular_2048.jpg");
const texCloud  = loader.load("https://threejs.org/examples/textures/planets/earth_clouds_1024.png");

[texEarth, texNormal, texSpec, texCloud].forEach(t=>{ t.colorSpace = THREE.SRGBColorSpace; t.anisotropy = 8; });

const earthMat = new THREE.MeshStandardMaterial({
  map: texEarth,
  normalMap: texNormal,
  metalness: 0.05,
  roughness: 0.85,
  emissive: new THREE.Color(0x050a12),
  emissiveIntensity: 0.5,
});
earthMat.specularMap = texSpec;

const earth = new THREE.Mesh(new THREE.SphereGeometry(radius, 192, 192), earthMat);
globeGroup.add(earth);

const cloudMat = new THREE.MeshLambertMaterial({
  map: texCloud,
  transparent:true,
  opacity:0.55,
  depthWrite:false,
});
const clouds = new THREE.Mesh(new THREE.SphereGeometry(radius*1.01, 160, 160), cloudMat);
globeGroup.add(clouds);

// atmosphere fresnel
const atmMat = new THREE.ShaderMaterial({
  transparent:true,
  blending: THREE.AdditiveBlending,
  uniforms: {
    c: { value: 0.25 },
    p: { value: 2.8 },
    glowColor: { value: new THREE.Color(0x77d8ff) },
    viewVector: { value: camera.position }
  },
  vertexShader: `
    uniform vec3 viewVector;
    uniform float c;
    uniform float p;
    varying float intensity;
    void main(){
      vec3 vNormal = normalize(normalMatrix * normal);
      vec3 vNormel = normalize(normalMatrix * viewVector);
      intensity = pow(c - dot(vNormal, vNormel), p);
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
    }
  `,
  fragmentShader: `
    uniform vec3 glowColor;
    varying float intensity;
    void main(){
      vec3 col = glowColor * intensity;
      gl_FragColor = vec4(col, intensity);
    }
  `
});
const atmosphere = new THREE.Mesh(new THREE.SphereGeometry(radius*1.04, 160, 160), atmMat);
globeGroup.add(atmosphere);

// route tubes
const routeGroup = new THREE.Group();
globeGroup.add(routeGroup);
let markers=[], tubes=[], trailLine=null, vehicle=null, energyTex=null, energyTex2=null;

function makeEnergyTexture(color1="rgba(120,200,255,1)", color2="rgba(255,210,120,1)"){
  const c=document.createElement("canvas");
  c.width=512; c.height=32;
  const ctx=c.getContext("2d");
  const g=ctx.createLinearGradient(0,0,c.width,0);
  g.addColorStop(0.00,"rgba(0,0,0,0)");
  g.addColorStop(0.15,color1);
  g.addColorStop(0.50,color2);
  g.addColorStop(0.85,color1);
  g.addColorStop(1.00,"rgba(0,0,0,0)");
  ctx.fillStyle=g;
  ctx.fillRect(0,0,c.width,c.height);
  for(let i=0;i<140;i++){
    const x=Math.random()*c.width;
    const a=0.08+Math.random()*0.10;
    ctx.fillStyle=`rgba(255,255,255,${a})`;
    ctx.fillRect(x, 10+Math.random()*12, 1+Math.random()*2, 2+Math.random()*5);
  }
  const tex=new THREE.CanvasTexture(c);
  tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
  tex.repeat.set(2,1);
  tex.colorSpace = THREE.SRGBColorSpace;
  return tex;
}
energyTex = makeEnergyTexture("rgba(120,200,255,1)","rgba(255,230,160,1)");
energyTex2 = makeEnergyTexture("rgba(120,255,200,1)","rgba(120,200,255,1)");

function makeMarker(lat, lon, color){
  const p=latLonToVec3(lat,lon,radius*1.004);
  const g=new THREE.SphereGeometry(0.12, 20,20);
  const m=new THREE.MeshBasicMaterial({color, transparent:true, opacity:0.95});
  const s=new THREE.Mesh(g,m);
  s.position.copy(p);
  s.userData.pulse = Math.random()*10;
  return s;
}

function arcCurve(a,b,height){
  const A=latLonToVec3(a.lat,a.lon,radius);
  const B=latLonToVec3(b.lat,b.lon,radius);
  const mid=A.clone().add(B).multiplyScalar(0.5).normalize().multiplyScalar(radius+height);
  return new THREE.QuadraticBezierCurve3(A, mid, B);
}

function makeTube(points, mode="plane"){
  const curve = new THREE.CatmullRomCurve3(points);
  const tubeGeo = new THREE.TubeGeometry(curve, 320, mode==="plane" ? 0.07 : 0.055, 10, false);
  const mat = new THREE.MeshBasicMaterial({
    map: mode==="plane" ? energyTex : energyTex2,
    transparent:true,
    opacity: 0.85,
    blending: THREE.AdditiveBlending,
    depthWrite:false,
  });
  return new THREE.Mesh(tubeGeo, mat);
}

function makeVehicle(mode){
  const s=256;
  const c=document.createElement("canvas"); c.width=c.height=s;
  const ctx=c.getContext("2d");
  const glow=ctx.createRadialGradient(s/2,s/2,10,s/2,s/2,s/2);
  glow.addColorStop(0, mode==="plane"?"rgba(120,200,255,.35)":"rgba(255,210,120,.28)");
  glow.addColorStop(1, "rgba(0,0,0,0)");
  ctx.fillStyle=glow; ctx.fillRect(0,0,s,s);
  ctx.save();
  ctx.translate(s/2,s/2);
  ctx.strokeStyle = mode==="plane"?"rgba(200,240,255,.95)":"rgba(255,240,210,.95)";
  ctx.lineWidth=10; ctx.lineCap="round"; ctx.lineJoin="round";
  if(mode==="plane"){
    ctx.beginPath();
    ctx.moveTo(0,-90); ctx.lineTo(0,90);
    ctx.moveTo(0,-10); ctx.lineTo(-70,25);
    ctx.moveTo(0,-10); ctx.lineTo(70,25);
    ctx.moveTo(0,55); ctx.lineTo(-35,78);
    ctx.moveTo(0,55); ctx.lineTo(35,78);
    ctx.stroke();
  } else {
    ctx.beginPath();
    ctx.moveTo(-90,10); ctx.lineTo(-60,-40); ctx.lineTo(60,-40); ctx.lineTo(90,10);
    ctx.moveTo(-80,10); ctx.lineTo(80,10);
    ctx.stroke();
    ctx.fillStyle = "rgba(255,210,120,.95)";
    ctx.beginPath(); ctx.arc(-55,40,18,0,Math.PI*2); ctx.arc(55,40,18,0,Math.PI*2); ctx.fill();
  }
  ctx.restore();
  const tex=new THREE.CanvasTexture(c);
  tex.minFilter=THREE.LinearFilter;
  const sp=new THREE.Sprite(new THREE.SpriteMaterial({map:tex, transparent:true, opacity:0.95, depthTest:false}));
  sp.scale.set(1.35,1.35,1.35);
  return sp;
}

function clearRoute(){
  markers.forEach(m=>routeGroup.remove(m));
  tubes.forEach(t=>routeGroup.remove(t));
  markers=[]; tubes=[];
  if(trailLine) routeGroup.remove(trailLine);
  if(vehicle) routeGroup.remove(vehicle);
  trailLine=null; vehicle=null;
}

let pathPoints = [];
let pathCursor = 0;

function buildTrip(trip){
  clearRoute();
  pathPoints = [];
  pathCursor = 0;

  trip.legs.forEach((p,i)=>{
    const color = i===0 ? 0xffd278 : (i===trip.legs.length-1 ? 0x7affc8 : 0x7ad2ff);
    const mk=makeMarker(p.lat,p.lon,color);
    markers.push(mk); routeGroup.add(mk);
  });

  const height = trip.mode==="plane" ? 5.2 : 2.5;
  for(let i=0;i<trip.legs.length-1;i++){
    const c = arcCurve(trip.legs[i], trip.legs[i+1], height);
    const pts = c.getPoints(180);
    if(i>0) pts.shift();
    pathPoints.push(...pts);
  }

  const tube = makeTube(pathPoints, trip.mode);
  tubes.push(tube);
  routeGroup.add(tube);

  vehicle = makeVehicle(trip.mode);
  routeGroup.add(vehicle);

  const trailGeo = new THREE.BufferGeometry();
  const trailCount = 90;
  const trailPos = new Float32Array(trailCount*3);
  trailGeo.setAttribute("position", new THREE.BufferAttribute(trailPos,3));
  const trailMat = new THREE.LineBasicMaterial({
    color: trip.mode==="plane" ? 0x8fe0ff : 0xffd278,
    transparent:true,
    opacity:0.55,
    blending: THREE.AdditiveBlending
  });
  trailLine = new THREE.Line(trailGeo, trailMat);
  trailLine.frustumCulled = false;
  routeGroup.add(trailLine);

  const target = trip.legs[Math.floor(trip.legs.length/2)];
  globeGroup.userData.targetRotY = (-(target.lon) * Math.PI/180) * 0.62;
  globeGroup.userData.targetRotX = ((target.lat) * Math.PI/180) * 0.22;
  camera.userData.targetZ = trip.mode==="plane" ? 34 : 30;
}

function setTrip(i){
  const trip = trips[i];
  document.querySelectorAll(".day").forEach(el=>el.classList.toggle("active", Number(el.dataset.day)===trip.day));
  titleEl.textContent = `DAY ${trip.day}ï½œ${trip.routeText}`;
  modeEl.textContent = MODE[trip.mode];
  statusEl.textContent = trip.mode==="plane" ? "æ’­æ”¾ä¸­ Â· é£è¡Œèˆªçº¿" : "æ’­æ”¾ä¸­ Â· å…¬è·¯ç§»åŠ¨";
  buildTrip(trip);
}

// postprocessing
const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
const bloom = new UnrealBloomPass(new THREE.Vector2(800, 1400), 0.9, 0.55, 0.12);
composer.addPass(bloom);

const VignetteShader = {
  uniforms: { tDiffuse:{value:null}, offset:{value:1.12}, darkness:{value:1.15} },
  vertexShader: `varying vec2 vUv; void main(){ vUv=uv; gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);} `,
  fragmentShader: `
    uniform sampler2D tDiffuse;
    uniform float offset;
    uniform float darkness;
    varying vec2 vUv;
    void main(){
      vec4 c = texture2D(tDiffuse, vUv);
      vec2 uv = (vUv - 0.5) * offset;
      float vignette = 1.0 - dot(uv, uv);
      vignette = clamp(vignette, 0.0, 1.0);
      c.rgb *= pow(vignette, darkness);
      gl_FragColor = c;
    }
  `
};
composer.addPass(new ShaderPass(VignetteShader));
composer.addPass(new FilmPass(0.28, 0.05, 648, false));

function resize(){
  const r = canvas.getBoundingClientRect();
  renderer.setSize(r.width, r.height, false);
  camera.aspect = r.width / r.height;
  camera.updateProjectionMatrix();
  composer.setSize(r.width, r.height);
}
window.addEventListener("resize", resize);
resize();

// playback
let idx = 0;
const perSlideMs = 3600;
let slideStart = performance.now();
setTrip(0);

let introStart = performance.now();
let introDone = false;

function animate(t){
  requestAnimationFrame(animate);

  earth.rotation.y += 0.0009;
  clouds.rotation.y += 0.0012;

  const ty = globeGroup.userData.targetRotY ?? 0;
  const tx = globeGroup.userData.targetRotX ?? 0;
  globeGroup.rotation.y += (ty - globeGroup.rotation.y) * 0.018;
  globeGroup.rotation.x += (tx - globeGroup.rotation.x) * 0.018;

  if(!introDone){
    const p = Math.min(1, (t - introStart)/1200);
    const e = 1 - Math.pow(1-p, 3);
    const tz = camera.userData.targetZ ?? 34;
    camera.position.z = 46 - (46 - tz) * e;
    if(p>=1) introDone = true;
  } else {
    const tz = camera.userData.targetZ ?? 34;
    camera.position.z += (tz - camera.position.z) * 0.03;
  }

  markers.forEach((m,i)=>{
    m.userData.pulse += 0.03;
    m.material.opacity = 0.70 + 0.25*(0.5 + 0.5*Math.sin(m.userData.pulse + i));
  });

  tubes.forEach((tb, i)=>{
    if(tb.material.map) tb.material.map.offset.x = (tb.material.map.offset.x - 0.012) % 1;
    tb.material.opacity = 0.78 + 0.12*Math.sin(t*0.004 + i);
  });

  if(vehicle && pathPoints.length>10){
    const speed = 0.85;
    pathCursor = (pathCursor + speed) % (pathPoints.length-1);
    const i = Math.floor(pathCursor);
    const p = pathPoints[i];
    const p2 = pathPoints[Math.min(pathPoints.length-1, i+2)];
    vehicle.position.copy(p);

    const dir = p2.clone().sub(p).normalize();
    vehicle.material.rotation = Math.atan2(dir.y, dir.x);
    vehicle.material.opacity = 0.85;

    const arr = trailLine.geometry.attributes.position.array;
    for(let k=arr.length-3; k>=3; k--) arr[k] = arr[k-3];
    arr[0]=p.x; arr[1]=p.y; arr[2]=p.z;
    trailLine.geometry.attributes.position.needsUpdate = true;
    trailLine.material.opacity = 0.35 + 0.25*Math.sin(t*0.005);
  }

  const elapsed = t - slideStart;
  barEl.style.width = `${Math.min(1, elapsed/perSlideMs)*100}%`;
  if(elapsed >= perSlideMs){
    idx = (idx + 1) % trips.length;
    slideStart = t;
    setTrip(idx);
  }

  composer.render();
}
requestAnimationFrame(animate);

</script>
</body>
</html>
