
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ“ä½œæŠ¥ä»·å•ï¼ˆç½‘é¡µç‰ˆ v18Â·ç™»å½•ç‰ˆï¼‰</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #020617;
      --accent: #38bdf8;
      --border-subtle: rgba(148,163,184,0.35);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --radius-xl: 18px;
    }
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 24px;
      background: radial-gradient(circle at top, #1e293b 0, #020617 52%, #000 100%);
      color: var(--text-main);
    }
    .app-shell {
      max-width: 1320px;
      margin: 0 auto;
    }
    .app-title {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 16px;
    }
    .app-title h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.04em;
    }
    .chip {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.75);
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--text-muted);
    }
    .grid {
      display: grid;
      grid-template-columns: minmax(0,1fr);
      gap: 16px;
      margin-bottom: 16px;
    }
    .card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.12), rgba(15,23,42,0.88));
      border-radius: var(--radius-xl);
      padding: 16px 18px 14px;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 18px 60px rgba(15,23,42,0.85);
      backdrop-filter: blur(26px);
    }
    .card--flat {
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), #020617);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 12px;
    }
    .card-header h2 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--text-muted);
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
      flex: 1;
    }
    .field label {
      font-size: 11px;
      color: var(--text-muted);
    }
    .field input[type="text"],
    .field input[type="number"],
    .field input[type="date"],
    .login-panel input[type="password"] {
      width: 100%;
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15,23,42,0.7);
      color: var(--text-main);
      outline: none;
    }
    .field input[readonly] {
      background: rgba(15,23,42,0.3);
      color: var(--text-muted);
    }
    .field input:focus,
    .login-panel input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.6);
    }
    .field-row {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
    }
    .field--compact input {
      padding: 4px 6px;
      font-size: 11px;
    }
    #tripDays,
    #profitCoef {
      min-width: 72px;
      text-align: center;
    }
    #tourCode {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .field--profit-highlight input[readonly] {
      background: #064e3b;
      color: #fecaca;
      border-color: #22c55e;
      font-weight: 600;
    }
    .table-wrapper {
      margin-top: 6px;
      border-radius: calc(var(--radius-xl) - 4px);
      border: 1px solid rgba(148,163,184,0.35);
      overflow: hidden;
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), #020617);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 980px;
      font-size: 11px;
    }
    thead {
      background: linear-gradient(to right, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(30,41,59,0.9);
      text-align: center;
      white-space: nowrap;
    }
    th {
      font-weight: 500;
      color: var(--text-muted);
    }
    tbody tr:nth-child(even) td {
      background: rgba(15,23,42,0.6);
    }
    tbody tr:nth-child(odd) td {
      background: rgba(2,6,23,0.9);
    }
    tbody tr:hover td {
      background: rgba(15,23,42,0.95);
    }
    td input[type="text"],
    td input[type="number"],
    td input[type="date"] {
      padding: 2px 4px;
      font-size: 11px;
      border-radius: 9px;
      border: 1px solid rgba(30,64,175,0.55);
      background: rgba(15,23,42,0.85);
      color: var(--text-main);
      outline: none;
      width: 100%;
      text-align: center;
    }
    td input[readonly] {
      border-style: dashed;
      border-color: rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.4);
      color: var(--text-muted);
    }
    td input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.6);
    }
    td input[type="date"] {
      width: 90px;
      min-width: 90px;
    }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
    .summary-row {
      background: linear-gradient(to right, rgba(15,23,42,1), rgba(15,23,42,0.96)) !important;
      font-size: 11px;
    }
    .summary-row td {
      border-top: 1px solid rgba(148,163,184,0.35);
      border-bottom: none;
      font-weight: 500;
    }
    .key-metrics {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
    }
    .metric {
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.4);
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(15,23,42,0.85));
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .metric--highlight {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.4);
      background: radial-gradient(circle at top, rgba(56,189,248,0.18), rgba(15,23,42,0.9));
    }
    .metric label {
      font-size: 11px;
      color: var(--text-muted);
    }
    .metric span {
      font-size: 14px;
      font-weight: 600;
    }
    .metric small {
      font-size: 10px;
      color: var(--text-muted);
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    button {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.12), rgba(15,23,42,0.96));
      color: var(--text-main);
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button.primary {
      border-color: var(--accent);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.28), rgba(56,189,248,0.08));
    }
    button.danger {
      border-color: rgba(248,113,113,0.8);
      background: radial-gradient(circle at top left, rgba(248,113,113,0.25), rgba(15,23,42,0.95));
    }
    button span.icon {
      font-size: 14px;
    }
    .saas-grid {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 6px;
      margin-top: 4px;
    }
    .saas-item {
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.9);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .saas-item span.label {
      color: var(--text-muted);
    }
    .saas-item span.value {
      font-variant-numeric: tabular-nums;
    }
    .hint {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    /* å¤šäººæ•°æ¡£æŠ¥ä»·è¡¨ */
    .tier-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 4px;
    }
    .tier-table th,
    .tier-table td {
      border-bottom: 1px solid rgba(30,41,59,0.9);
      padding: 3px 4px;
      text-align: center;
      white-space: nowrap;
    }
    .tier-table th {
      color: var(--text-muted);
      font-weight: 500;
    }
    .tier-table input[type="number"],
    .tier-table input[readonly] {
      width: 70px;
      max-width: 70px;
      padding: 2px 4px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid rgba(51,65,85,0.9);
      background: rgba(15,23,42,0.85);
      color: var(--text-main);
      outline: none;
      text-align: center;
    }
    .tier-table input[readonly] {
      border-style: dashed;
      border-color: rgba(148,163,184,0.7);
      color: var(--text-muted);
    }
    .tier-table input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.6);
    }
    @media (max-width: 1040px) {
      .grid {
        grid-template-columns: minmax(0,1fr);
      }
    }

    /* ç™»å½•ç•Œé¢æ ·å¼ */
    #login-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(2,6,23,0.98));
      z-index: 999;
    }
    .login-panel {
      width: 320px;
      padding: 20px 22px 18px;
      border-radius: 18px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: 0 24px 60px rgba(0,0,0,0.8);
    }
    .login-panel h2 {
      margin: 0 0 8px;
      font-size: 18px;
      text-align: center;
    }
    .login-panel p {
      margin: 0 0 12px;
      font-size: 12px;
      text-align: center;
      color: var(--text-muted);
    }
    .login-panel .field {
      margin-bottom: 10px;
    }
    .login-panel button {
      width: 100%;
      justify-content: center;
      margin-top: 4px;
    }
    .login-error {
      margin-top: 6px;
      font-size: 11px;
      color: #fca5a5;
      min-height: 14px;
      text-align: center;
    }
  </style>
</head>
<body>

<!-- ç™»å½•é®ç½© -->
<div id="login-screen">
  <div class="login-panel">
    <h2>ç™»å½•æŠ¥ä»·å·¥å…·</h2>
    <p>è¯·è¾“å…¥è´¦å·å’Œå¯†ç </p>
    <div class="field">
      <label for="login-user">è´¦å·</label>
      <input id="login-user" type="text" autocomplete="off" />
    </div>
    <div class="field">
      <label for="login-pass">å¯†ç </label>
      <input id="login-pass" type="password" autocomplete="off" />
    </div>
    <button class="primary" type="button" onclick="doLogin()">
      <span class="icon">ğŸ”</span><span>ç™»å½•</span>
    </button>
    <div class="login-error" id="login-error"></div>
  </div>
</div>

<!-- ä¸»åº”ç”¨ -->
<div id="app" style="display:none;">
  <div class="app-shell">
    <div class="app-title">
      <h1>æ“ä½œæŠ¥ä»·å• Â· Web ç‰ˆ v18</h1>
      <span class="chip">ç™»å½•ç‰ˆ Â· å¤šäººæ•°æ¡£æµ‹ç®— Â· æ”¯æŒ HTML è‰ç¨¿å½’æ¡£</span>
    </div>

    
      <div class="card">
        <div class="card-header">
          <h2>åŸºç¡€ä¿¡æ¯ Â· Header</h2>
        </div>
        <div class="field-row">
          <div class="field field--compact">
            <label for="quoteDate">æŠ¥ä»·æ—¥æœŸ</label>
            <input id="quoteDate" type="date" />
          </div>
          <div class="field field--compact">
            <label for="tourCode">å›¢å·ï¼ˆå¿…å¡«ï¼‰</label>
            <input id="tourCode" type="text" placeholder="ä¾‹å¦‚ GBT2602010A0610025+1" />
          </div>
        </div>
        <div class="field-row">
          <div class="field field--compact">
            <label for="pax">äººæ•°ï¼ˆå«é¢†é˜Ÿï¼‰</label>
            <input id="pax" type="number" step="1" min="0" value="16" />
          </div>
          <div class="field field--compact">
            <label for="leaders">é¢†é˜Ÿäººæ•°</label>
            <input id="leaders" type="number" step="1" min="0" value="1" />
          </div>
          <div class="field field--compact">
            <label for="tripDays">è¡Œç¨‹å¤©æ•°ï¼ˆå¤©ï¼‰</label>
            <input id="tripDays" type="number" step="1" min="1" />
          </div>
        </div>
        <div class="field-row">
          <div class="field field--compact">
            <label for="carType">è½¦å‹</label>
            <input id="carType" type="text" placeholder="ä¾‹å¦‚ 49 åº§å¤§å·´" />
          </div>
          <div class="field field--compact">
            <label for="singleCoef">å•æˆ¿å·®ç³»æ•°</label>
            <input id="singleCoef" type="number" step="0.01" value="0.95" />
          </div>
          <div class="field field--compact">
            <label for="r7">å°è´¹ï¼ˆç”¨äºåˆ¤æ–­å¤©æ•°åˆ†æ®µï¼‰</label>
            <input id="r7" type="number" step="1" value="4" />
          </div>
        </div>
        <div class="field-row">
          <div class="field field--compact">
            <label for="organizer">ç»„å›¢ç¤¾</label>
            <input id="organizer" type="text" />
          </div>
          <div class="field field--compact">
            <label for="operator">æ“ä½œ</label>
            <input id="operator" type="text" />
          </div>
        </div>
      </div>


  <div class="grid">
          </div>

      <div class="card card--flat">
        <div class="card-header">
          <h2>å…³é”®ç»“æœ Â· Key Metrics</h2>
        </div>
        <div class="key-metrics">
          <div class="metric">
            <label>æ€»æŠ¥ä»·ï¼ˆä¸å«å•æˆ¿å·®ï¼‰</label>
            <span id="out_B38">0.00</span>
            <small>å•ä½ï¼šEUR / å›¢</small>
          </div>
          <div class="metric">
            <label>å•æˆ¿å·®åˆè®¡</label>
            <span id="out_N38">0.00</span>
            <small>å•ä½ï¼šEUR / å›¢</small>
          </div>
          <div class="metric">
            <label>æœ€ç»ˆæŠ¥ä»·ï¼ˆå«å•æˆ¿å·®ï¼‰</label>
            <span id="out_R38">0.00</span>
            <small>å•ä½ï¼šEUR / å›¢</small>
          </div>
          <div class="metric metric--highlight">
            <label>äººå‡æŠ¥ä»·ï¼ˆæˆæœ¬ï¼‰</label>
            <span id="out_H38">0.00</span>
            <small>è®¡ç®—æ–¹å¼ï¼šæ€»æŠ¥ä»· Ã·ï¼ˆäººæ•° âˆ’ é¢†é˜Ÿï¼‰</small>
          </div>
        </div>

        <div style="margin-top:10px;border-top:1px solid rgba(148,163,184,0.35);padding-top:8px">
          <div class="field-row">
            <div class="field field--compact">
              <label for="profitCoef">åˆ©æ¶¦ç³»æ•°</label>
              <input id="profitCoef" type="number" step="0.01" list="profit-presets" value="1.25" />
              <datalist id="profit-presets">
                <option value="1.05"></option>
                <option value="1.10"></option>
                <option value="1.15"></option>
                <option value="1.20"></option>
                <option value="1.25"></option>
                <option value="1.30"></option>
              </datalist>
            </div>
            <div class="field field--compact field--profit-highlight">
              <label>å«åˆ©æ¶¦äººå‡ä»·</label>
              <input id="out_F50" type="text" readonly />
            </div>
            <div class="field field--compact">
              <label>å«åˆ©æ¶¦æ€»å›¢æ¬¾</label>
              <input id="out_totalProfit" type="text" readonly />
            </div>
          </div>
          <div class="field-row">
            <div class="field field--compact">
              <label for="reverseTarget">åæŠ¥ä»·ï¼šç›®æ ‡äººå‡ä»·</label>
              <input id="reverseTarget" type="number" step="0.01" />
            </div>
            <div class="field field--compact">
              <label>å¯¹åº”åˆ©æ¶¦ç³»æ•°</label>
              <input id="out_E52" type="text" readonly />
            </div>
            <div class="field field--compact">
              <label>åæŠ¥ä»·æ€»å›¢æ¬¾</label>
              <input id="out_reverseTotal" type="text" readonly />
            </div>
          </div>
          <div class="hint">è¯´æ˜ï¼šæ²¿ç”¨ä½ åŸ Excel çš„åˆ©æ¶¦ç³»æ•° / åæŠ¥ä»·é€»è¾‘ï¼Œå¯ç›´æ¥ç”¨æ¥è¯•ä»·ã€åæ¨åˆ©æ¶¦ç‡ã€‚</div>
        </div>

        <div style="margin-top:10px;border-top:1px solid rgba(148,163,184,0.35);padding-top:8px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
            <span style="font-size:11px;color:var(--text-muted);letter-spacing:.06em;text-transform:uppercase;">å¤šäººæ•°æ¡£æŠ¥ä»·</span>
            <div style="display:flex;align-items:center;gap:6px;">
              <span style="font-size:10px;color:var(--text-muted);">åŒä¸€å¥—æˆæœ¬ä¸‹ï¼Œå¿«é€ŸæŸ¥çœ‹ä¸åŒâ€œå®¢äºº+é¢†é˜Ÿâ€çš„æŠ¥ä»·</span>
              <button type="button" style="padding:2px 8px;font-size:10px;border-radius:999px;" onclick="addTier()">
                ï¼‹ äººæ¡£
              </button>
            </div>
          </div>
          <table class="tier-table">
            <thead>
              <tr>
                <th>æ¡£ä½</th>
                <th>å®¢äººï¼ˆäººï¼‰</th>
                <th>é¢†é˜Ÿï¼ˆäººï¼‰</th>
                <th>æ€»äººæ•°</th>
                <th>äººå‡æˆæœ¬</th>
                <th>å«åˆ©æ¶¦äººå‡ä»·</th>
                <th>å«åˆ©æ¶¦æ€»å›¢æ¬¾</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>æ¡£ 1</td>
                <td><input type="number" step="1" min="0" id="tier0_guest" /></td>
                <td><input type="number" step="1" min="0" id="tier0_leader" /></td>
                <td><input type="number" id="tier0_total" readonly /></td>
                <td><input type="number" id="tier0_cost" readonly /></td>
                <td><input type="number" id="tier0_sell" readonly /></td>
                <td><input type="number" id="tier0_totalSell" readonly /></td>
              </tr>
              <tr>
                <td>æ¡£ 2</td>
                <td><input type="number" step="1" min="0" id="tier1_guest" /></td>
                <td><input type="number" step="1" min="0" id="tier1_leader" /></td>
                <td><input type="number" id="tier1_total" readonly /></td>
                <td><input type="number" id="tier1_cost" readonly /></td>
                <td><input type="number" id="tier1_sell" readonly /></td>
                <td><input type="number" id="tier1_totalSell" readonly /></td>
              </tr>
              <tr>
                <td>æ¡£ 3</td>
                <td><input type="number" step="1" min="0" id="tier2_guest" /></td>
                <td><input type="number" step="1" min="0" id="tier2_leader" /></td>
                <td><input type="number" id="tier2_total" readonly /></td>
                <td><input type="number" id="tier2_cost" readonly /></td>
                <td><input type="number" id="tier2_sell" readonly /></td>
                <td><input type="number" id="tier2_totalSell" readonly /></td>
              </tr>
              <tr>
                <td>æ¡£ 4</td>
                <td><input type="number" step="1" min="0" id="tier3_guest" /></td>
                <td><input type="number" step="1" min="0" id="tier3_leader" /></td>
                <td><input type="number" id="tier3_total" readonly /></td>
                <td><input type="number" id="tier3_cost" readonly /></td>
                <td><input type="number" id="tier3_sell" readonly /></td>
                <td><input type="number" id="tier3_totalSell" readonly /></td>
              </tr>
              <tr>
                <td>æ¡£ 5</td>
                <td><input type="number" step="1" min="0" id="tier4_guest" /></td>
                <td><input type="number" step="1" min="0" id="tier4_leader" /></td>
                <td><input type="number" id="tier4_total" readonly /></td>
                <td><input type="number" id="tier4_cost" readonly /></td>
                <td><input type="number" id="tier4_sell" readonly /></td>
                <td><input type="number" id="tier4_totalSell" readonly /></td>
              </tr>
            </tbody>
          </table>
          <div class="hint">ç”¨æ³•ç¤ºä¾‹ï¼š15+1ã€20+1ã€25+1ã€20+0ã€10+1â€¦â€¦å…¨éƒ¨å¡«åœ¨ä¸Šé¢ 5 æ¡£é‡Œï¼Œç³»ç»Ÿè‡ªåŠ¨æŒ‰å½“å‰æˆæœ¬ + åˆ©æ¶¦ç³»æ•°ç®—å‡ºå„æ¡£æŠ¥ä»·ã€‚</div>
        </div>

        <div class="btn-row">
          <button class="primary" type="button" onclick="exportCSV()">
            <span class="icon">â¬‡</span><span>å¯¼å‡ºä¸º CSV / Excel</span>
          </button>
          <button type="button" onclick="saveAsHtmlDraft()">
            <span class="icon">ğŸ“„</span><span>å¦å­˜ä¸º HTML è‰ç¨¿</span>
          </button>
          <button class="danger" type="button" onclick="resetAll()">
            <span class="icon">ğŸ§¹</span><span>æ¸…ç©ºæ‰€æœ‰è¾“å…¥</span>
          </button>
        </div>
        <div class="hint">è¯´æ˜ï¼šCSV ä¸º UTF-8 å¸¦ BOM ç¼–ç ï¼ŒExcel ç›´æ¥æ‰“å¼€å³å¯æ­£å¸¸æ˜¾ç¤ºä¸­æ–‡ï¼›HTML è‰ç¨¿ä¼šæŠŠå½“å‰æ•°æ®å†™è¿›æ–‡ä»¶ä¸­ï¼Œé€‚åˆå¤‡ä»½å’Œå½’æ¡£ã€‚</div>
      </div>
    </div>

    <div class="card" style="margin-top:4px">
      <div class="card-header">
        <h2>æ¯æ—¥æˆæœ¬æ˜ç»†</h2>
        <button type="button" class="primary" onclick="addRow()" style="padding:4px 9px;font-size:11px;">
          <span class="icon">ï¼‹</span><span>æ·»åŠ ä¸€è¡Œ</span>
        </button>
      </div>
      <div class="table-wrapper">
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>å¤©æ•°</th>
                <th>åŸå¸‚</th>
                <th>ç”¨è½¦<br>(æ¬§/å¤©)</th>
                <th>ä½å®¿<br>æ˜Ÿçº§</th>
                <th>å‚è€ƒ<br>é…’åº—</th>
                <th>ä½å®¿<br>(æ¬§/äºº)</th>
                <th>å•é—´æ•°</th>
                <th>å•é—´<br>ä»·æ ¼</th>
                <th>å•æˆ¿å·®<br>å°è®¡</th>
                <th>æ—©é¤<br>(æ¬§/äºº)</th>
                <th>åˆé¤<br>(æ¬§/äºº)</th>
                <th>æ™šé¤<br>(æ¬§/äºº)</th>
                <th>æ™¯ç‚¹<br>åç§°</th>
                <th>æ™¯ç‚¹è´¹ç”¨<br>(æ¬§/äºº)</th>
                <th>å®˜å¯¼<br>(æ¬§)</th>
                <th>çŸ¿æ³‰æ°´<br>(æ¬§/ç“¶/äºº)</th>
                <th>å°è´¹</th>
                <th>å¯¼æœ<br>(æ¬§/å¤©)</th>
                <th>å¸å¯¼<br>ä½å®¿</th>
                <th>å¸å¯¼<br>é¤è¡¥</th>
              </tr>
            </thead>
            <tbody id="detail-rows">
            </tbody>
            <tfoot>
              <tr class="summary-row">
                <td>å•é¡¹å°è®¡</td>
                <td id="out_B37"></td>
                <td></td>
                <td id="out_D37"></td>
                <td></td>
                <td></td>
                <td id="out_G37"></td>
                <td></td>
                <td id="out_I37"></td>
                <td id="out_J37"></td>
                <td id="out_K37"></td>
                <td id="out_L37"></td>
                <td id="out_M37"></td>
                <td></td>
                <td id="out_O37"></td>
                <td id="out_P37"></td>
                <td id="out_Q37"></td>
                <td id="out_R37"></td>
                <td id="out_S37"></td>
                <td id="out_T37"></td>
                <td id="out_U37"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
      <div class="hint">è¯´æ˜ï¼šæ˜ç»†åŒºæ¯è¡Œå¯¹åº”ä¸€å¤©æˆ–ä¸€æ®µè¡Œç¨‹ï¼Œä½ å¯ä»¥éšæ—¶ç‚¹å‡»â€œæ·»åŠ ä¸€è¡Œâ€ç»§ç»­å¾€ä¸‹åŠ ï¼Œæ‰€æœ‰å…¬å¼è‡ªåŠ¨åŒæ­¥ã€‚</div>
    </div>

    <div class="card card--flat" style="margin-top:10px">
      <div class="card-header">
        <h2>æˆæœ¬æ‹†åˆ† Â· SaaS å¯¹æ¥åŒº</h2>
      </div>
      <div class="saas-grid">
        <div class="saas-item">
          <span class="label">é…’åº—æˆæœ¬ï¼ˆä½å®¿æ€»è®¡Ã—äººæ•° + å•æˆ¿å·®ï¼‰</span>
          <span class="value" id="out_E39">0.00</span>
        </div>
        <div class="saas-item">
          <span class="label">ç”¨è½¦æˆæœ¬ï¼ˆå«å¸æœºå°è´¹åˆ†æ‘Šï¼‰</span>
          <span class="value" id="out_G39">0.00</span>
        </div>
        <div class="saas-item">
          <span class="label">ç”¨é¤æˆæœ¬ï¼ˆäººæ•°Ã—æ—©åˆæ™šæ€»è®¡ï¼‰</span>
          <span class="value" id="out_I39">0.00</span>
        </div>
        <div class="saas-item">
          <span class="label">é¤è¡¥æˆæœ¬</span>
          <span class="value" id="out_K39">0.00</span>
        </div>
        <div class="saas-item">
          <span class="label">æ™¯ç‚¹æˆæœ¬ï¼ˆæ™¯ç‚¹æ€»è®¡Ã—äººæ•°ï¼‰</span>
          <span class="value" id="out_M39">0.00</span>
        </div>
        <div class="saas-item">
          <span class="label">å®˜å¯¼æˆæœ¬</span>
          <span class="value" id="out_O39">0.00</span>
        </div>
        <div class="saas-item">
          <span class="label">å¯¼æ¸¸æˆæœ¬ï¼ˆå«éƒ¨åˆ†å°è´¹åˆ†æ‘Šï¼‰</span>
          <span class="value" id="out_Q39">0.00</span>
        </div>
        <div class="saas-item">
          <span class="label">å¸å¯¼ä½å®¿æˆæœ¬</span>
          <span class="value" id="out_S39">0.00</span>
        </div>
        <div class="saas-item">
          <span class="label">çŸ¿æ³‰æ°´æˆæœ¬ï¼ˆçŸ¿æ³‰æ°´Ã—å®é™…ä»˜è´¹äººæ•°ï¼‰</span>
          <span class="value" id="out_U39">0.00</span>
        </div>
        <div class="saas-item">
          <span class="label">æ€»æˆæœ¬ï¼ˆä»¥ä¸Šé¡¹ç›®åˆè®¡ï¼‰</span>
          <span class="value" id="out_C39">0.00</span>
        </div>
      </div>
      <div class="hint">è¿™ä¸€å—ç…§ç€ä½ åŸæ¥çš„æ‹†åˆ†é€»è¾‘ï¼Œåªæ˜¯æŠŠ Excel å•å…ƒæ ¼ç¼–å·éƒ½éšè—æ‰äº†ï¼Œæ–¹ä¾¿ç›´æ¥å¯¹æ¥ç³»ç»Ÿã€‚</div>
    </div>
  </div>
</div>

<script>
  let ROW_COUNT = 30;
  let TIER_COUNT = 5;

  function doLogin() {
    const u = document.getElementById("login-user").value.trim();
    const p = document.getElementById("login-pass").value;
    const err = document.getElementById("login-error");
    if (u === "KK" && p === "baojia@10") {
      err.textContent = "";
      document.getElementById("login-screen").style.display = "none";
      document.getElementById("app").style.display = "block";
    } else {
      err.textContent = "è´¦å·æˆ–å¯†ç é”™è¯¯ï¼Œè¯·å†è¯•ä¸€æ¬¡ã€‚";
    }
  }

  function num(id) {
    const el = document.getElementById(id);
    if (!el) return 0;
    const raw = (el.value || "").toString().replace(",", ".");
    const v = parseFloat(raw);
    return isNaN(v) ? 0 : v;
  }
  function setText(id, value, digits = 2) {
    const el = document.getElementById(id);
    if (!el) return;
    if (typeof value === "number") {
      el.textContent = value.toFixed(digits);
    } else {
      el.textContent = value || "";
    }
  }
  function setInputValue(id, value, digits = 2) {
    const el = document.getElementById(id);
    if (!el) return;
    if (typeof value === "number") {
      el.value = value.toFixed(digits);
    } else {
      el.value = value || "";
    }
  }

  function autosizeInput(el) {
    // ç™»å½•é¢æ¿ & éƒ¨åˆ†åŸºç¡€ä¿¡æ¯å­—æ®µï¼Œä¿æŒå…¨å®½ï¼Œä¸åšå®½åº¦ç¼©æ”¾
    if (el.closest(".login-panel")) {
      el.style.width = "100%";
      return;
    }
    if (["tourCode","carType","singleCoef","organizer","operator","pax","leaders","tripDays","r7"].includes(el.id)) {
      el.style.width = "100%";
      return;
    }
    if (el.closest("#detail-rows")) {
      if (/_city$|_hotelName$|_spotName$/.test(el.id)) {
        const content = (el.value || el.placeholder || "");
        const len = Math.max(content.length, 1);
        const hasCJK = /[\u4e00-\u9fff]/.test(content);
        let ch;
        if (hasCJK) {
          ch = Math.min(len * 2 + 4, 40);
        } else {
          ch = Math.min(len * 1.1 + 6, 26);
        }
        el.style.width = ch + "ch";
      } else {
        el.style.width = "100%";
      }
      return;
    }
    if (el.type === "date") return;
    const content = (el.value || el.placeholder || "");
    const len = Math.max(content.length, 1);
    const ch = Math.max(4, Math.min(len + 1, 24));
    el.style.width = ch + "ch";
  }

  function buildRows() {
    const tbody = document.getElementById("detail-rows");
    tbody.innerHTML = "";
    for (let i = 0; i < ROW_COUNT; i++) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="date" id="r${i}_date" /></td>
        <td><input type="number" step="1" id="r${i}_days" value="0" /></td>
        <td><input type="text" id="r${i}_city" /></td>
        <td><input type="number" step="0.01" id="r${i}_car" /></td>
        <td><input type="text" id="r${i}_star" /></td>
        <td><input type="text" id="r${i}_hotelName" /></td>
        <td><input type="number" step="0.01" id="r${i}_hotelPax" /></td>
        <td><input type="number" step="0.01" id="r${i}_qty" /></td>
        <td><input type="number" step="0.01" id="r${i}_I" readonly /></td>
        <td><input type="number" step="0.01" id="r${i}_J" readonly /></td>
        <td><input type="number" step="0.01" id="r${i}_K" /></td>
        <td><input type="number" step="0.01" id="r${i}_L" /></td>
        <td><input type="number" step="0.01" id="r${i}_M" /></td>
        <td><input type="text" id="r${i}_spotName" /></td>
        <td><input type="number" step="0.01" id="r${i}_O" /></td>
        <td><input type="number" step="0.01" id="r${i}_P" /></td>
        <td><input type="number" step="0.01" id="r${i}_Q" /></td>
        <td><input type="number" step="0.01" id="r${i}_R" /></td>
        <td><input type="number" step="0.01" id="r${i}_S" /></td>
        <td><input type="number" step="0.01" id="r${i}_T" /></td>
        <td><input type="number" step="0.01" id="r${i}_U" /></td>
      `;
      tbody.appendChild(tr);
    }
  }

  function addRow() {
    const tbody = document.getElementById("detail-rows");
    const i = ROW_COUNT;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="date" id="r${i}_date" /></td>
      <td><input type="number" step="1" id="r${i}_days" value="0" /></td>
      <td><input type="text" id="r${i}_city" /></td>
      <td><input type="number" step="0.01" id="r${i}_car" /></td>
      <td><input type="text" id="r${i}_star" /></td>
      <td><input type="text" id="r${i}_hotelName" /></td>
      <td><input type="number" step="0.01" id="r${i}_hotelPax" /></td>
      <td><input type="number" step="0.01" id="r${i}_qty" /></td>
      <td><input type="number" step="0.01" id="r${i}_I" readonly /></td>
      <td><input type="number" step="0.01" id="r${i}_J" readonly /></td>
      <td><input type="number" step="0.01" id="r${i}_K" /></td>
      <td><input type="number" step="0.01" id="r${i}_L" /></td>
      <td><input type="number" step="0.01" id="r${i}_M" /></td>
      <td><input type="text" id="r${i}_spotName" /></td>
      <td><input type="number" step="0.01" id="r${i}_O" /></td>
      <td><input type="number" step="0.01" id="r${i}_P" /></td>
      <td><input type="number" step="0.01" id="r${i}_Q" /></td>
      <td><input type="number" step="0.01" id="r${i}_R" /></td>
      <td><input type="number" step="0.01" id="r${i}_S" /></td>
      <td><input type="number" step="0.01" id="r${i}_T" /></td>
      <td><input type="number" step="0.01" id="r${i}_U" /></td>
    `;
    tbody.appendChild(tr);
    ROW_COUNT++;
    recalc();
  }


  function addTier() {
    const tbody = document.querySelector(".tier-table tbody");
    if (!tbody) return;
    const i = TIER_COUNT;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>æ¡£ ${i + 1}</td>
      <td><input type="number" step="1" min="0" id="tier${i}_guest" /></td>
      <td><input type="number" step="1" min="0" id="tier${i}_leader" /></td>
      <td><input type="number" id="tier${i}_total" readonly /></td>
      <td><input type="number" id="tier${i}_cost" readonly /></td>
      <td><input type="number" id="tier${i}_sell" readonly /></td>
      <td><input type="number" id="tier${i}_totalSell" readonly /></td>
    `;
    tbody.appendChild(tr);
    TIER_COUNT++;
    recalc();
  }

  function applyTripDaysToRows() {
    const tripDays = num("tripDays");
    if (!tripDays || tripDays <= 0) return;
    for (let i = 0; i < ROW_COUNT; i++) {
      const dayInput = document.getElementById(`r${i}_days`);
      if (!dayInput) continue;
      if (i < tripDays) {
        if (!dayInput.value || dayInput.value === "0") dayInput.value = "1";
      } else {
        if (!dayInput.value || dayInput.value === "1") dayInput.value = "0";
      }
    }
  }

  function recalc() {
    const pax = num("pax");
    const leaders = num("leaders");
    const singleCoef = num("singleCoef");
    const r7 = num("r7");
    const profitCoef = num("profitCoef");

    let sumB = 0, sumD = 0, sumG = 0, sumI = 0, sumJ = 0;
    let sumK = 0, sumL = 0, sumM = 0, sumO = 0;
    let sumP = 0, sumQ = 0, sumR = 0, sumS = 0, sumT = 0, sumU = 0;

    for (let i = 0; i < ROW_COUNT; i++) {
      const hotelPerPax = num(`r${i}_hotelPax`);
      const qty = num(`r${i}_qty`);

      const I_val = (2 * singleCoef - 1) * hotelPerPax;
      const J_val = qty * I_val;

      setInputValue(`r${i}_I`, I_val);
      setInputValue(`r${i}_J`, J_val);

      const b = num(`r${i}_days`);
      const d = num(`r${i}_car`);
      const k = num(`r${i}_K`);
      const l = num(`r${i}_L`);
      const m = num(`r${i}_M`);
      const o = num(`r${i}_O`);
      const p = num(`r${i}_P`);
      const q = num(`r${i}_Q`);
      const r = num(`r${i}_R`);
      const s = num(`r${i}_S`);
      const t = num(`r${i}_T`);
      const u = num(`r${i}_U`);

      sumB += b;
      sumD += d;
      sumG += hotelPerPax;
      sumI += I_val;
      sumJ += J_val;
      sumK += k;
      sumL += l;
      sumM += m;
      sumO += o;
      sumP += p;
      sumQ += q;
      sumR += r;
      sumS += s;
      sumT += t;
      sumU += u;
    }

    setText("out_B37", sumB);
    setText("out_D37", sumD);
    setText("out_G37", sumG);
    setText("out_I37", sumI);
    setText("out_J37", sumJ);
    setText("out_K37", sumK);
    setText("out_L37", sumL);
    setText("out_M37", sumM);
    setText("out_O37", sumO);
    setText("out_P37", sumP);
    setText("out_Q37", sumQ);
    setText("out_R37", sumR);
    setText("out_S37", sumS);
    setText("out_T37", sumT);
    setText("out_U37", sumU);

    function calcFor(B3, D3) {
      const paying = Math.max(B3 - D3, 0);
      if (B3 <= 0 || paying <= 0) {
        return { B38: 0, H38: 0, R38: sumJ, paying: 0 };
      }
      const part1 = sumD + sumS + sumT + sumU + sumP + sumJ;
      const part2 = (sumG + sumK + sumL + sumM + sumO) * B3;
      const part3 = sumQ * paying;
      const part4 = sumR * paying;

      const W5 = part1 + part2 + part3 + part4;
      const W6 = sumD + sumR + sumS + sumT + sumU + sumP + sumJ
        + (sumG + sumK + sumL + sumM + sumO + sumQ) * B3;

      const B38 = (r7 <= 5 ? W5 : W6);
      const H38 = paying > 0 ? (B38 / paying) : 0;
      const R38 = B38 + sumJ;
      return { B38, H38, R38, paying };
    }

    const baseRes = calcFor(pax, leaders);
    const B38 = baseRes.B38;
    const N38 = sumJ;
    const H38 = baseRes.H38;
    const R38 = baseRes.R38;

    setText("out_B38", B38);
    setText("out_N38", N38);
    setText("out_H38", H38);
    setText("out_R38", R38);

    const E50 = profitCoef;
    const F50 = H38 * E50;
    setInputValue("out_F50", F50);

    const F52 = num("reverseTarget");
    const E52 = H38 > 0 ? (F52 / H38) : 0;
    setInputValue("out_E52", E52);

    const payingBase = baseRes.paying;
    const totalProfit = F50 * payingBase;
    const reverseTotal = F52 * payingBase;

    setInputValue("out_totalProfit", totalProfit);
    setInputValue("out_reverseTotal", reverseTotal);

    // å¤šäººæ•°æ¡£æŠ¥ä»·
    for (let i = 0; i < TIER_COUNT; i++) {
      const guestEl = document.getElementById(`tier${i}_guest`);
      const leaderEl = document.getElementById(`tier${i}_leader`);
      const totalEl = document.getElementById(`tier${i}_total`);
      const costEl = document.getElementById(`tier${i}_cost`);
      const sellEl = document.getElementById(`tier${i}_sell`);
      const totalSellEl = document.getElementById(`tier${i}_totalSell`);
      if (!guestEl || !leaderEl || !totalEl) continue;

      const g = num(`tier${i}_guest`);
      const l = num(`tier${i}_leader`);
      if (!g && !l) {
        totalEl.value = "";
        if (costEl) costEl.value = "";
        if (sellEl) sellEl.value = "";
        if (totalSellEl) totalSellEl.value = "";
        continue;
      }
      const B3_t = g + l;
      const D3_t = l;
      const res = calcFor(B3_t, D3_t);
      totalEl.value = B3_t || "";
      if (costEl) costEl.value = res.H38 ? res.H38.toFixed(2) : "";
      const sell = res.H38 * profitCoef;
      if (sellEl) sellEl.value = sell ? sell.toFixed(2) : "";
      const tierTotal = sell * res.paying;
      if (totalSellEl) totalSellEl.value = tierTotal ? tierTotal.toFixed(2) : "";
    }

    const B3 = pax;
    const B3_minus_D3 = Math.max(B3 - leaders, 0);

    const E39 = sumG * B3 + sumJ;
    const G39 = (r7 >= 5)
      ? (sumD + sumR / 2)
      : (sumD + (sumR / 2) * (B3 - 1));
    const I39 = B3 * (sumK + sumL + sumM);
    const K39 = sumU;
    const M39 = sumO * B3;
    const O39 = sumP;
    const Q39 = (r7 >= 5)
      ? (sumS + sumR / 2)
      : (sumS + (sumR / 2) * (B3 - 1));
    const S39 = sumT;
    const U39 = sumQ * (B3_minus_D3);

    const C39 = E39 + G39 + I39 + K39 + M39 + O39 + Q39 + S39 + U39;

    setText("out_E39", E39);
    setText("out_G39", G39);
    setText("out_I39", I39);
    setText("out_K39", K39);
    setText("out_M39", M39);
    setText("out_O39", O39);
    setText("out_Q39", Q39);
    setText("out_S39", S39);
    setText("out_U39", U39);
    setText("out_C39", C39);
  }

  function exportCSV() {
    const lines = [];

    const quoteDate = document.getElementById("quoteDate").value || "";
    const pax = num("pax");
    const leaders = num("leaders");
    const tripDays = num("tripDays");
    const carType = document.getElementById("carType").value || "";
    const singleCoef = num("singleCoef");
    const organizer = document.getElementById("organizer").value || "";
    const operatorName = document.getElementById("operator").value || "";
    const tourCode = document.getElementById("tourCode").value || "";
    const r7 = num("r7");

    lines.push(["===== åŸºç¡€ä¿¡æ¯ ====="].join(","));
    lines.push(["æŠ¥ä»·æ—¥æœŸ", quoteDate]);
    lines.push(["äººæ•°ï¼ˆå«é¢†é˜Ÿï¼‰", pax]);
    lines.push(["é¢†é˜Ÿäººæ•°", leaders]);
    lines.push(["è¡Œç¨‹å¤©æ•°", tripDays]);
    lines.push(["è½¦å‹", `"${carType.replace(/"/g,'""')}"`]);
    lines.push(["å•æˆ¿å·®ç³»æ•°", singleCoef]);
    lines.push(["å°è´¹é˜ˆå€¼ï¼ˆR7ï¼‰", r7]);
    lines.push(["ç»„å›¢ç¤¾", `"${organizer.replace(/"/g,'""')}"`]);
    lines.push(["æ“ä½œ", `"${operatorName.replace(/"/g,'""')}"`]);
    lines.push(["å›¢å·", `"${tourCode.replace(/"/g,'""')}"`]);
    lines.push([]);

    const B38 = document.getElementById("out_B38").textContent || "0";
    const N38 = document.getElementById("out_N38").textContent || "0";
    const R38 = document.getElementById("out_R38").textContent || "0";
    const H38 = document.getElementById("out_H38").textContent || "0";
    const F50 = document.getElementById("out_F50").value || "0";
    const E52 = document.getElementById("out_E52").value || "0";
    const totalProfit = document.getElementById("out_totalProfit").value || "0";
    const reverseTotal = document.getElementById("out_reverseTotal").value || "0";

    lines.push(["===== å…³é”®ç»“æœï¼ˆåŸºç¡€äººæ•°ï¼‰ ====="].join(","));
    lines.push(["æ€»æŠ¥ä»·ï¼ˆä¸å«å•æˆ¿å·®ï¼‰", B38]);
    lines.push(["å•æˆ¿å·®åˆè®¡", N38]);
    lines.push(["æœ€ç»ˆæŠ¥ä»·ï¼ˆå«å•æˆ¿å·®ï¼‰", R38]);
    lines.push(["äººå‡æŠ¥ä»·ï¼ˆæˆæœ¬ï¼‰", H38]);
    lines.push(["åˆ©æ¶¦ç³»æ•°", num("profitCoef")]);
    lines.push(["å«åˆ©æ¶¦äººå‡ä»·", F50]);
    lines.push(["å«åˆ©æ¶¦æ€»å›¢æ¬¾", totalProfit]);
    lines.push(["åæŠ¥ä»·ç›®æ ‡äººå‡ä»·", num("reverseTarget")]);
    lines.push(["åæ¨åˆ©æ¶¦ç³»æ•°", E52]);
    lines.push(["åæŠ¥ä»·æ€»å›¢æ¬¾", reverseTotal]);
    lines.push([]);

    lines.push(["===== å¤šäººæ•°æ¡£æŠ¥ä»· ====="].join(","));
    lines.push(["æ¡£ä½","å®¢äººï¼ˆäººï¼‰","é¢†é˜Ÿï¼ˆäººï¼‰","æ€»äººæ•°","äººå‡æˆæœ¬","å«åˆ©æ¶¦äººå‡ä»·","å«åˆ©æ¶¦æ€»å›¢æ¬¾"].join(","));
    for (let i = 0; i < TIER_COUNT; i++) {
      function gvTier(id) {
        const el = document.getElementById(id);
        return el ? (el.value || "") : "";
      }
      const row = [
        `æ¡£ ${i+1}`,
        gvTier(`tier${i}_guest`),
        gvTier(`tier${i}_leader`),
        gvTier(`tier${i}_total`),
        gvTier(`tier${i}_cost`),
        gvTier(`tier${i}_sell`),
        gvTier(`tier${i}_totalSell`)
      ];
      lines.push(row.join(","));
    }
    lines.push([]);

    lines.push(["===== æ¯æ—¥æˆæœ¬æ˜ç»† ====="].join(","));
    lines.push([
      "æ—¥æœŸ","å¤©æ•°","åŸå¸‚","ç”¨è½¦(æ¬§/å¤©)","ä½å®¿æ˜Ÿçº§","å‚è€ƒé…’åº—",
      "ä½å®¿(æ¬§/äºº)","å•é—´æ•°","å•é—´ä»·æ ¼","å•æˆ¿å·®å°è®¡",
      "æ—©é¤(æ¬§/äºº)","åˆé¤(æ¬§/äºº)","æ™šé¤(æ¬§/äºº)",
      "æ™¯ç‚¹åç§°","æ™¯ç‚¹è´¹ç”¨(æ¬§/äºº)",
      "å®˜å¯¼(æ¬§)","çŸ¿æ³‰æ°´(æ¬§/ç“¶/äºº)","å°è´¹","å¯¼æœ(æ¬§/å¤©)","å¸å¯¼ä½å®¿","å¸å¯¼é¤è¡¥"
    ].join(","));

    for (let i = 0; i < ROW_COUNT; i++) {
      function gv(id) {
        const el = document.getElementById(id);
        if (!el) return "";
        let v = el.value || "";
        if (v.includes(",") || v.includes('"')) {
          v = `"${v.replace(/"/g, '""')}"`;
        }
        return v;
      }
      const row = [
        gv(`r${i}_date`),
        gv(`r${i}_days`),
        gv(`r${i}_city`),
        gv(`r${i}_car`),
        gv(`r${i}_star`),
        gv(`r${i}_hotelName`),
        gv(`r${i}_hotelPax`),
        gv(`r${i}_qty`),
        gv(`r${i}_I`),
        gv(`r${i}_J`),
        gv(`r${i}_K`),
        gv(`r${i}_L`),
        gv(`r${i}_M`),
        gv(`r${i}_spotName`),
        gv(`r${i}_O`),
        gv(`r${i}_P`),
        gv(`r${i}_Q`),
        gv(`r${i}_R`),
        gv(`r${i}_S`),
        gv(`r${i}_T`),
        gv(`r${i}_U`)
      ];
      lines.push(row.join(","));
    }

    lines.push([]);
    lines.push(["===== å•é¡¹å°è®¡ ====="].join(","));
    lines.push(["å¤©æ•°", document.getElementById("out_B37").textContent || "0"]);
    lines.push(["ç”¨è½¦", document.getElementById("out_D37").textContent || "0"]);
    lines.push(["ä½å®¿(æ¬§/äºº)", document.getElementById("out_G37").textContent || "0"]);
    lines.push(["å•æˆ¿å·®", document.getElementById("out_J37").textContent || "0"]);
    lines.push(["æ—©é¤", document.getElementById("out_K37").textContent || "0"]);
    lines.push(["åˆé¤", document.getElementById("out_L37").textContent || "0"]);
    lines.push(["æ™šé¤", document.getElementById("out_M37").textContent || "0"]);
    lines.push(["æ™¯ç‚¹è´¹ç”¨", document.getElementById("out_O37").textContent || "0"]);
    lines.push(["çŸ¿æ³‰æ°´", document.getElementById("out_Q37").textContent || "0"]);
    lines.push(["å°è´¹", document.getElementById("out_R37").textContent || "0"]);
    lines.push(["å¯¼æœ", document.getElementById("out_S37").textContent || "0"]);
    lines.push(["å¸å¯¼ä½å®¿", document.getElementById("out_T37").textContent || "0"]);
    lines.push(["å¸å¯¼é¤è¡¥", document.getElementById("out_U37").textContent || "0"]);
    lines.push([]);

    lines.push(["===== æˆæœ¬æ‹†åˆ† ====="].join(","));
    lines.push(["æ€»æˆæœ¬ï¼ˆå„é¡¹åˆè®¡ï¼‰", document.getElementById("out_C39").textContent || "0"]);
    lines.push(["é…’åº—æˆæœ¬", document.getElementById("out_E39").textContent || "0"]);
    lines.push(["ç”¨è½¦æˆæœ¬", document.getElementById("out_G39").textContent || "0"]);
    lines.push(["ç”¨é¤æˆæœ¬", document.getElementById("out_I39").textContent || "0"]);
    lines.push(["é¤è¡¥æˆæœ¬", document.getElementById("out_K39").textContent || "0"]);
    lines.push(["æ™¯ç‚¹æˆæœ¬", document.getElementById("out_M39").textContent || "0"]);
    lines.push(["å®˜å¯¼æˆæœ¬", document.getElementById("out_O39").textContent || "0"]);
    lines.push(["å¯¼æ¸¸æˆæœ¬", document.getElementById("out_Q39").textContent || "0"]);
    lines.push(["å¸å¯¼ä½å®¿æˆæœ¬", document.getElementById("out_S39").textContent || "0"]);
    lines.push(["çŸ¿æ³‰æ°´æˆæœ¬", document.getElementById("out_U39").textContent || "0"]);

    const csvContent = lines.map(l => Array.isArray(l) ? l.join(",") : l).join("\r\n");
    const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const safeCode = tourCode || "quote";
    a.href = url;
    a.download = `${safeCode}_quote.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function saveAsHtmlDraft() {
    const quoteDate = document.getElementById("quoteDate").value || "";
    const tourCodeRaw = document.getElementById("tourCode").value || "";
    if (!tourCodeRaw.trim()) {
      alert("è¯·å…ˆå¡«å†™å›¢å·ï¼Œå†è¿›è¡Œâ€œå¦å­˜ä¸º HTML è‰ç¨¿â€ã€‚");
      return;
    }
    const safeTourCode = tourCodeRaw.trim().replace(/[\\\\/:*?"<>|]/g, "_");
    let datePrefix = "";
    if (quoteDate) {
      const parts = quoteDate.split("-");
      if (parts.length === 3) {
        const m = parts[1];
        const d = parts[2];
        datePrefix = `(${m}.${d})`;
      }
    }
    const defaultName = `${datePrefix}${safeTourCode}` || "quote_draft";
    const name = prompt("è¯·è¾“å…¥è‰ç¨¿æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰ï¼š", defaultName);
    if (!name) return;

    const data = {
      quoteDate: quoteDate,
      pax: num("pax"),
      leaders: num("leaders"),
      tripDays: num("tripDays"),
      carType: document.getElementById("carType").value || "",
      singleCoef: num("singleCoef"),
      organizer: document.getElementById("organizer").value || "",
      operator: document.getElementById("operator").value || "",
      tourCode: tourCodeRaw,
      r7: num("r7"),
      profitCoef: num("profitCoef"),
      reverseTarget: num("reverseTarget"),
      rowCount: ROW_COUNT,
      rows: [],
      tiers: []
    };
    for (let i = 0; i < ROW_COUNT; i++) {
      function gv(id) {
        const el = document.getElementById(id);
        return el ? (el.value || "") : "";
      }
      data.rows.push({
        date: gv(`r${i}_date`),
        days: gv(`r${i}_days`),
        city: gv(`r${i}_city`),
        car: gv(`r${i}_car`),
        star: gv(`r${i}_star`),
        hotelName: gv(`r${i}_hotelName`),
        hotelPax: gv(`r${i}_hotelPax`),
        qty: gv(`r${i}_qty`),
        K: gv(`r${i}_K`),
        L: gv(`r${i}_L`),
        M: gv(`r${i}_M`),
        spotName: gv(`r${i}_spotName`),
        O: gv(`r${i}_O`),
        P: gv(`r${i}_P`),
        Q: gv(`r${i}_Q`),
        R: gv(`r${i}_R`),
        S: gv(`r${i}_S`),
        T: gv(`r${i}_T`),
        U: gv(`r${i}_U`)
      });
    }
    for (let i = 0; i < TIER_COUNT; i++) {
      function gvTier(id) {
        const el = document.getElementById(id);
        return el ? (el.value || "") : "";
      }
      data.tiers.push({
        guest: gvTier(`tier${i}_guest`),
        leader: gvTier(`tier${i}_leader`)
      });
    }

    const stateJson = JSON.stringify(data).replace(/</g, "\\u003c");
    const docHtml = document.documentElement.outerHTML;
    const injection = `<script>window.__EMBEDDED_STATE__ = ${stateJson};<\\/script>`;
    let finalHtml;
    if (docHtml.includes("</head>")) {
      finalHtml = docHtml.replace("</head>", injection + "</head>");
    } else {
      finalHtml = injection + docHtml;
    }

    const blob = new Blob([finalHtml], { type: "text/html;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${name}.html`; 
    a.click();
    URL.revokeObjectURL(url);
  }

  function loadFromLocal() {
    let data = null;
    if (window.__EMBEDDED_STATE__) {
      data = window.__EMBEDDED_STATE__;
    } else {
      const raw = localStorage.getItem("quoteToolDraft_v12");
      if (raw) {
        try { data = JSON.parse(raw); } catch(e) { console.error("è§£ææœ¬åœ°ç¼“å­˜å¤±è´¥", e); }
      }
    }
    if (!data) return;

    document.getElementById("quoteDate").value = data.quoteDate || "";
    document.getElementById("pax").value = data.pax ?? "";
    document.getElementById("leaders").value = data.leaders ?? "";
    document.getElementById("tripDays").value = data.tripDays ?? "";
    document.getElementById("carType").value = data.carType || "";
    document.getElementById("singleCoef").value = data.singleCoef ?? "";
    document.getElementById("organizer").value = data.organizer || "";
    document.getElementById("operator").value = data.operator || "";
    document.getElementById("tourCode").value = data.tourCode || "";
    document.getElementById("r7").value = data.r7 ?? "4";
    document.getElementById("profitCoef").value = data.profitCoef ?? "1.25";
    document.getElementById("reverseTarget").value = data.reverseTarget ?? "";

    if (typeof data.rowCount === "number" && data.rowCount > 0) {
      ROW_COUNT = data.rowCount;
    }
    buildRows();

    if (Array.isArray(data.rows)) {
      for (let i = 0; i < Math.min(ROW_COUNT, data.rows.length); i++) {
        const row = data.rows[i];
        function sv(id, v) {
          const el = document.getElementById(id);
          if (el) {
            el.value = v ?? "";
            autosizeInput(el);
          }
        }
        sv(`r${i}_date`, row.date);
        sv(`r${i}_days`, row.days);
        sv(`r${i}_city`, row.city);
        sv(`r${i}_car`, row.car);
        sv(`r${i}_star`, row.star);
        sv(`r${i}_hotelName`, row.hotelName);
        sv(`r${i}_hotelPax`, row.hotelPax);
        sv(`r${i}_qty`, row.qty);
        sv(`r${i}_K`, row.K);
        sv(`r${i}_L`, row.L);
        sv(`r${i}_M`, row.M);
        sv(`r${i}_spotName`, row.spotName);
        sv(`r${i}_O`, row.O);
        sv(`r${i}_P`, row.P);
        sv(`r${i}_Q`, row.Q);
        sv(`r${i}_R`, row.R);
        sv(`r${i}_S`, row.S);
        sv(`r${i}_T`, row.T);
        sv(`r${i}_U`, row.U);
      }
    }

    if (Array.isArray(data.tiers)) {
      for (let i = 0; i < data.tiers.length; i++) {
        if (i >= TIER_COUNT) {
          addTier();
        }
        const t = data.tiers[i] || {};
        const gEl = document.getElementById(`tier${i}_guest`);
        const lEl = document.getElementById(`tier${i}_leader`);
        if (gEl) gEl.value = t.guest ?? "";
        if (lEl) lEl.value = t.leader ?? "";
      }
    }
    applyTripDaysToRows();
    recalc();
  }

  function initDefaultTiersIfEmpty() {
    let any = false;
    for (let i = 0; i < TIER_COUNT; i++) {
      const g = document.getElementById(`tier${i}_guest`);
      const l = document.getElementById(`tier${i}_leader`);
      if (!g || !l) continue;
      if ((g.value && g.value !== "0") || (l.value && l.value !== "0")) {
        any = true;
        break;
      }
    }
    if (!any) {
      const pax = num("pax");
      const leaders = num("leaders");
      const guests = Math.max(pax - leaders, 0);
      const g0 = document.getElementById("tier0_guest");
      const l0 = document.getElementById("tier0_leader");
      if (g0) g0.value = guests || "";
      if (l0) l0.value = leaders || "";
    }
  }

  function resetAll() {
    if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) return;
    document.querySelectorAll("input").forEach(el => {
      if (el.type === "button") return;
      if (el.id === "profitCoef") { el.value = "1.25"; return; }
      if (el.id === "singleCoef") { el.value = "0.95"; return; }
      if (el.id === "pax") { el.value = "16"; return; }
      if (el.id === "leaders") { el.value = "1"; return; }
      if (el.id === "r7") { el.value = "4"; return; }
      if (el.id.startsWith("r") && el.id.endsWith("_days")) { el.value = "0"; return; }
      el.value = "";
      autosizeInput(el);
    });
    ROW_COUNT = 30;
    buildRows();
    const qd = document.getElementById("quoteDate");
    if (qd) {
      const today = new Date();
      qd.value = today.toISOString().slice(0,10);
    }
    initDefaultTiersIfEmpty();
    applyTripDaysToRows();
    recalc();
  }

  function autoFillNextDate(changedId, value) {
    const match = changedId.match(/^r(\\d+)_date$/);
    if (!match) return;
    const idx = parseInt(match[1], 10);
    const tripDays = num("tripDays");

    const d = new Date(value);
    if (isNaN(d.getTime())) return;

    if (idx === 0 && tripDays > 0) {
      for (let i = 0; i < ROW_COUNT; i++) {
        const dateInput = document.getElementById(`r${i}_date`);
        if (!dateInput) continue;
        if (i < tripDays) {
          const di = new Date(d.getTime());
          di.setDate(d.getDate() + i);
          const y = di.getFullYear();
          const m = String(di.getMonth() + 1).padStart(2, "0");
          const dd = String(di.getDate()).padStart(2, "0");
          dateInput.value = `${y}-${m}-${dd}`;
        }
      }
      applyTripDaysToRows();
    } else {
      const nextIdx = idx + 1;
      if (nextIdx >= ROW_COUNT) return;
      const nextEl = document.getElementById(`r${nextIdx}_date`);
      if (!nextEl || nextEl.value) return;
      d.setDate(d.getDate() + 1);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      nextEl.value = `${y}-${m}-${dd}`;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    buildRows();
    loadFromLocal();
    const qd = document.getElementById("quoteDate");
    if (qd && !qd.value) {
      const today = new Date();
      qd.value = today.toISOString().slice(0,10);
    }
    initDefaultTiersIfEmpty();
    recalc();

    const lu = document.getElementById("login-user");
    if (lu) lu.focus();

    document.body.addEventListener("input", (e) => {
      if (e.target.tagName === "INPUT") {
        autosizeInput(e.target);
        if (e.target.id === "tripDays") {
          applyTripDaysToRows();
        }
        recalc();
      }
    });

    document.body.addEventListener("change", (e) => {
      const t = e.target;
      if (t.tagName === "INPUT" && t.type === "date" && t.id.startsWith("r") && t.id.endsWith("_date")) {
        if (t.value) {
          autoFillNextDate(t.id, t.value);
          recalc();
        }
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && document.getElementById("login-screen").style.display !== "none") {
        doLogin();
      }
    });
  });
</script>
</body>
</html>
